---
description: TipTap 에디터 개발 규칙. 에디터 인스턴스, Extension, Decoration, 변환 패턴을 정의한다.
globs:
  - "src/editor/**"
  - "src/components/editor/**"
  - "src/components/panels/*Panel.tsx"
  - "src/utils/markdownConverter.ts"
alwaysApply: false
---

# TipTap 에디터 개발 규칙

TipTap(ProseMirror) 기반 에디터 관련 기능 개발 시 적용되는 규칙입니다.

---

## 1. 핵심 원칙

- **TipTap JSON이 canonical format**: HTML/Markdown은 변환용 (저장/AI 전송)
- JSON 구조 검증 후 저장, 파싱 실패 시 plain text fallback
- **Dual Editor**: Source (좌측) + Target (우측), 둘 다 편집 가능
- Focus Mode: Source 패널 숨김 가능 (3패널 → 2패널)
- **붙여넣기 정규화**: 웹/Confluence HTML은 **붙여넣기 시점에만** 최소한의 정규화 적용

---

## 2. 에디터 인스턴스 접근

### Editor Registry 패턴
```typescript
// src/editor/editorRegistry.ts
import { getSourceEditor, getTargetEditor } from '@/editor/editorRegistry';

// 비-에디터 컴포넌트에서 에디터 접근 (예: ReviewPanel)
const editor = getTargetEditor();
if (editor) {
  editor.commands.setContent(newContent);
}
```

### 컴포넌트 위치
- Editor 인스턴스: `src/components/panels/SourcePanel.tsx`, `TargetPanel.tsx`
- Document builders: `src/editor/sourceDocument.ts`, `targetDocument.ts`
- Store 연동: `projectStore.ts` → `setSourceDoc` / `setTargetDoc`

---

## 3. Extension 동기화 (필수)

**`TipTapEditor.tsx`의 extensions ↔ `markdownConverter.ts`의 `getExtensions()` 일치 필수**

```typescript
// 반드시 포함해야 하는 extensions:
// - StarterKit (기본)
// - Underline, Highlight, Subscript, Superscript (에디터 전용)
// - Link, Image, Table, TaskList 등

// 미일치 시 에러: "no mark type underline in schema"
```

### 지원 포맷
| 저장 가능 | 에디터 전용 (Markdown 변환 시 손실) |
|-----------|-----------------------------------|
| Headings (H1-H6), Lists, Bold, Italic, Strike, Blockquote, Links, Tables, Images | Underline, Highlight, Subscript, Superscript |

---

## 4. Cross-Node 검색 패턴

### buildTextWithPositions 패턴
```typescript
// 노드 경계를 넘는 텍스트 검색 시 필수
// 단순 indexOf는 개별 노드에서만 동작

import { buildTextWithPositions } from '@/editor/extensions/utils';

// 전체 텍스트 + 위치 매핑 구축 후 검색
const { text, positions } = buildTextWithPositions(doc);
const matchIndex = text.indexOf(searchTerm);
// positions 배열로 실제 ProseMirror 위치 계산
```

### 적용 위치
- `SearchHighlight.ts`: 검색/치환
- `ReviewHighlight.ts`: 리뷰 결과 하이라이트

---

## 5. Decoration 패턴

### SearchHighlight (검색/치환)
- CSS 기반, 비영구적
- 매치 결과 recalculate: 치환 후 위치 shift 반영
- 단축키: `Cmd+F` (Source/Target 검색), `Cmd+H` (Target 치환)

### ReviewHighlight (리뷰)
- Decoration 기반, 체크박스 연동
- 문서 변경 시 무효화 (cross-store subscription)
- `isApplyingSuggestion` 가드로 Apply 중 무효화 방지

```typescript
// ReviewHighlight 무효화 방지
reviewStore.isApplyingSuggestion = true;
try {
  editor.commands.insertContentAt(range, newContent);
} finally {
  reviewStore.isApplyingSuggestion = false;
}
```

---

## 6. Markdown 변환

### 변환 함수 (`src/utils/markdownConverter.ts`)
```typescript
// TipTap JSON → Markdown
tipTapJsonToMarkdown(json: JSONContent): string

// Markdown → TipTap JSON
markdownToTipTapJson(markdown: string): JSONContent

// HTML → TipTap JSON (프로젝트 로드 시)
htmlToTipTapJson(html: string): JSONContent
```

### 검색용 정규화 (`src/utils/normalizeForSearch.ts`)
```typescript
// Markdown 포맷 제거 후 검색
normalizeForSearch(text: string): string
stripMarkdownInline(text: string): string

// AI 응답의 excerpt에 markdown이 포함될 수 있음
// TipTap 에디터의 plain text와 매칭 전 정규화 필수
```

---

## 7. 프로젝트 로드 시 JSON 초기화

```typescript
// projectStore.ts - 프로젝트 로드 시
sourceDocJson = htmlToTipTapJson(sourceHtml);
targetDocJson = htmlToTipTapJson(targetHtml);

// 에디터 마운트 시가 아닌 프로젝트 로드 시 초기화
// Focus Mode에서 Source 패널 숨김 상태에서도 AI 도구 작동 보장
```

---

## 8. Common Gotchas

1. **Extension 스키마 불일치**: 에디터 ↔ 변환기 extensions 동기화 필수
2. **Cross-node 검색 실패**: `buildTextWithPositions()` 사용
3. **검색/치환 shortcut**: Source/Target `Cmd+F`, Target `Cmd+H`
4. **Review Apply vs Copy**: 오역/왜곡/일관성 → Apply(치환), 누락 → Copy(클립보드)
5. **Markdown 정규화**: AI excerpt ↔ 에디터 plain text 매칭 전 `normalizeForSearch()` 사용

---

## 9. Notion 스타일 UX

- 폰트: Pretendard
- 본문: 16px, line-height 1.8
- 최대 너비: 800px
- 블록 기반 편집 UX
