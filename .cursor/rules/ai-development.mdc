---
description: AI 기능 개발 규칙. Chat/Translation/Review 모드의 패턴, Token 제한, Common Gotchas를 정의한다.
globs:
  - "src/ai/**"
  - "src/components/chat/**"
  - "src/components/review/**"
  - "src/stores/chatStore.ts"
  - "src/stores/reviewStore.ts"
  - "src/stores/aiConfigStore.ts"
alwaysApply: false
---

# AI 기능 개발 규칙

AI 관련 기능(Chat, Translation, Review) 개발 시 적용되는 규칙입니다.

---

## 1. 핵심 아키텍처 패턴

### Chat 모드 (`src/ai/chat.ts`)
- **On-demand 문서 접근**: 초기 payload에 문서 미포함
- **Tool Calling**으로 필요 시 Source/Target 문서 fetch
- Chat history 최대 20개 메시지 (고정)
- 최대 6 steps (최대 12까지 확장) 허용
- 웹검색: `webSearchEnabled=true`일 때만 OpenAI 내장 `web_search_preview` 바인딩
- Confluence/Notion 등 커넥터: 토글 ON일 때만 MCP 도구 바인딩

### Translation 모드 (`src/ai/translateDocument.ts`)
- **Markdown 파이프라인**: TipTap JSON → Markdown → LLM → Markdown → TipTap JSON
- Chat history 미포함 (단일 요청)
- 출력 마커: `---TRANSLATION_START---` / `---TRANSLATION_END---`
- Dynamic `max_tokens`: 입력 문서 크기 기반 계산
- 스트리밍 번역 지원 (`translateWithStreaming`)

### Review 모드 (`src/ai/review/`)
- 문서를 청크로 분할 → 순차 AI 리뷰 → JSON 결과 파싱
- 청크 크기: `DEFAULT_REVIEW_CHUNK_SIZE` (12000자)
- 결과: 테이블 + 체크박스 + 액션 버튼 (Apply/Copy/Ignore)
- 출력 마커: `---REVIEW_START---` / `---REVIEW_END---`

---

## 2. Token 제한 (GPT-5 400k 기준)

| 항목 | 제한 |
|------|------|
| Translation Rules | 10,000자 |
| Project Context | 30,000자 |
| Glossary | 30,000자 |
| Documents (chat mode) | 100,000자 |
| Attachments (파일당) | 30,000자 |
| Attachments (총합) | 100,000자 |
| Context Blocks | 최대 20개, 블록당 500자 |

---

## 3. Tool Calling 구현

```typescript
// 도구 정의 위치: src/ai/chat.ts (LangChain Tool)

// 필수 도구:
// - get_source_document: Source 문서 Markdown 반환
// - get_target_document: Target 문서 Markdown 반환
// - suggest_translation_rule: 번역 규칙 제안
// - suggest_project_context: 프로젝트 컨텍스트 제안
```

**문서 도구는 Markdown 반환**: TipTap JSON → Markdown 변환 후 반환 (토큰 효율)
**저장 제안 도구**: suggest_*는 제안 생성 בלבד, 실제 저장은 UI 버튼으로만 수행

---

## 4. Common Gotchas (필독)

### AbortController 관련
- `AbortController` 생성만으로 취소 안됨 → `abort()` 호출 필수
- `abort()` 후 즉시 `abortController: null` 설정 (stale 참조 방지)
- `streamAssistantReply`에 `abortSignal` 전달 필수

### 스트리밍 관련
- `isFinalizingStreaming` 플래그로 race condition 방지
- 스트리밍 완료 대기 후 새 메시지 시작
- 기존 요청 abort 후 새 요청 시작 (응답 혼합 방지)

### JSON 파싱
- **Brace counting 사용**: `extractJsonObject` (`parseReviewResult.ts`)
- 탐욕적 정규식 금지 (중첩 객체/여분 브래킷 처리 불가)

### Tool Handler
- `project` null 체크 필수
- null일 때 명확한 에러 메시지: "프로젝트가 로드되지 않았습니다"

### 청크 처리
- `DEFAULT_REVIEW_CHUNK_SIZE` 상수 일관 사용
- 콜백 내 fresh state: `useChatStore.getState()` 사용

### 세션 관리
- 최대 세션 수 도달 시 `currentSession` null 체크
- Debounce 타이머: 프로젝트 ID 변경 여부 검증 후 persist

---

## 5. 이미지 처리

- Translation 전 이미지 플레이스홀더 치환 (`imagePlaceholder.ts`)
- `extractImages`: Base64 → 플레이스홀더 (토큰 99%+ 절약)
- `restoreImages`: 번역 후 플레이스홀더 → 원본 복원
- Chat 첨부 이미지는 멀티모달 입력으로 전달 (로컬 파일 → base64)

---

## 6. Truncation 감지

- 미완료 코드 블록, 미완성 링크 감지
- Conservative 접근: false positive 최소화
- Preview 모달에 Retry 버튼 표시 (recoverable 에러)

---

## 7. MCP/커넥터 통합 (Gate 원칙)

- **Web Search**: OpenAI 내장 `web_search_preview` 사용, `webSearchEnabled=true`일 때만 도구 바인딩
- **Confluence (Rovo MCP)**: Rust 네이티브 SSE 클라이언트 + OAuth 2.1 PKCE (lazy auth)
- **Notion (MCP)**: App Settings에서 연결/해제, 토큰은 SecretManager Vault 저장
- **커넥터 토글**: 채팅 탭 단위로 ON/OFF (OFF면 도구 바인딩 금지)

---

## 8. 상태 관리 패턴

### Cross-Store Subscription
```typescript
// reviewStore가 projectStore.targetDocJson 변경 감지
// 문서 변경 시 highlight 무효화
projectStore.subscribe(
  (state) => state.targetDocJson,
  () => { /* invalidate highlights */ }
);
```

### isApplyingSuggestion 가드
- Apply 작업 중 `reviewStore.isApplyingSuggestion = true` 설정
- Cross-store subscription의 highlight 무효화 방지
