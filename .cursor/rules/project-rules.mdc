---
description: project-rules
globs: "**/*"
alwaysApply: true
---
이 프로젝트의 최상위 기준 문서(Source of Truth)는 `prd.md` 와 `trd.md` 입니다.
다른 문서(README/ENV/tasks/progress 등) 및 코드가 이 문서들과 충돌하면, 원칙적으로 PRD/TRD에 맞추어 수정합니다.
불확실하거나 큰 설계 변경이 필요한 경우에는 먼저 질문으로 확인합니다.

---

## 0) 응답/커뮤니케이션 원칙
- 항상 한국어로 답합니다.
- 사용자가 명시적으로 요청(버튼/메뉴/단축키 등)하기 전에는 과도한 제안/개입을 하지 않습니다(Non-Intrusive AI).
- 확신 없는 내용은 추측하지 말고 확인 질문을 먼저 합니다.
- 변경은 최소 단위로, 이유/의도/리스크를 함께 설명합니다.

---

## 1) 제품 목표(PRD) 기반 UX 원칙
- **Document-First**: 번역가는 “문서 편집”에 집중해야 합니다. 복잡한 그리드/과한 UI를 피합니다.
- **3 패널**: Source(참조) / Target(편집) / AI(Chat). Focus Mode로 Source를 숨길 수 있어야 합니다.
- **Keyboard-First**: 핵심 플로우는 단축키 중심으로 설계합니다. (단, TRD의 “Pending Edit → Diff Preview → Keep/Discard” 모델을 우선합니다)
- **Smart Apply & Diff**: 모델 응답은 즉시 확정하지 않고 Pending Edit로 만든 뒤, Diff Preview 후 사용자가 한 번에 **Keep/Discard(=Accept/Reject)** 할 수 있어야 합니다.
- **Ghost Chips**: `{user}`, `<br>` 같은 태그/변수는 절대 손상되지 않도록 보호합니다.

---

## 2) 기술 목표(TRD) 기반 아키텍처 원칙
### 2.1 Tech Stack(목표)
- **Desktop**: Tauri + Rust
- **Frontend**: React + TypeScript
- **Editor**: Monaco Editor (Source/Target 2개 인스턴스)
- **State**: Zustand (+ 필요 시 Immer)
- **Storage**: SQLite(rusqlite) 기반 단일 `.ite` 프로젝트 파일
- **Diff**: diff-match-patch 기반 델타 계산 + 시각화

### 2.2 Monaco “Document Mode” 옵션(목표)
TRD의 문서 에디터 감성 옵션을 유지합니다:
- lineNumbers off, minimap off, glyphMargin false
- wordWrap on, renderLineHighlight none
- Pretendard, lineHeight 1.8, fontSize 16px

### 2.3 Range-based Tracking(목표)
- AI가 수정하는 동안 사용자가 다른 곳을 편집해도 정확히 적용되도록 “범위 추적”을 설계합니다.
- Monaco의 tracked range(ITrackedRange) 개념을 중심으로, 선택 범위를 ID로 추적하는 구조를 지향합니다.

---

## 3) AI 인터랙션(Pending Edit → Diff Preview → Keep/Discard)
### 3.1 On-Demand 트리거(요청 기반)
- 사용자의 **명시적 요청(버튼/메뉴/단축키 등)** 없이 자동 리라이트/자동 적용은 금지합니다.
- “Add to chat”은 **선택 텍스트를 프롬프트(채팅 입력)로 옮기는 보조 UX**이며, 단독으로 모델 호출을 발생시키지 않습니다.
- 모델 호출이 발생하는 기능은 “Edit 요청(교정/재작성)”과 “Translate 요청(번역 생성)”으로 구분합니다.

### 3.2 프롬프트/컨텍스트(=Context Collection)
- 컨텍스트는 TRD 기준으로 **“선택 영역 + 원문 맥락 + (가능하면) 용어집/참조 문서 + Active Memory(용어/톤 규칙)”** 순으로 구성합니다.
- **원문 컨텍스트(Source)**는 번역 도메인에서 최우선이므로, 가능하면 항상 payload에 포함합니다.
- 출력 포맷이 필요한 기능은 프롬프트에서 명확히 강제합니다.
  - Edit 요청(선택 범위): **선택 구간 대체 텍스트만**
  - Translate 요청: **번역문 전체만**
- 확정된 용어/스타일 규칙은 별도 메모리(요약)로 유지하여 일관성을 지킵니다(Smart Context Memory).

### 3.3 Pending Edit(편집 세션) & 적용 규칙
- 모델 응답은 즉시 본문에 확정하지 않고, **Pending Edit(편집 세션)**로 생성합니다.
- 변경 사항은 Keep/Discard 전에 반드시 Diff로 시각화합니다(추가=초록, 삭제=빨강).
- **Keep(=Accept)**: 제안사항을 실제 문서 텍스트에 반영하고, 미리보기/데코레이션을 제거합니다.
- **Discard(=Reject)**: 임시 변경/미리보기/데코레이션을 모두 제거하고 원문 상태로 복구합니다.

---

## 4) Ghost Chips(태그 보호) 규칙
- `{...}` 변수, `<tag>` 형태 HTML 태그, 줄바꿈(`<br>` 등)은 손상되면 안 됩니다.
- AI 전송 시에는 필요하면 “마스킹→복원” 전략을 사용하되, 최종 결과에서 원형 보존을 검증합니다.
- UI 상에서는 편집 불가능(ReadOnly)하게 보여주고, 복사/붙여넣기에서도 깨지지 않도록 처리합니다.

---

## 5) 데이터/저장 규칙(.ite)
- 프로젝트/블록/대화/스냅샷은 SQLite를 기준으로 영속화합니다.
- 자동 저장(Auto-save)은 사용자 경험을 해치지 않는 선에서 동작해야 합니다(지연/스레드/락 주의).
- Rust ↔ React IPC는 지연시간을 최소화하고, 대용량 저장 시에도 UI가 멈추지 않게 합니다.

---

## 6) 코드 변경 시 준수사항(실무 규율)
- PRD/TRD와 충돌하는 구현을 추가하지 않습니다. 필요한 경우 먼저 질문합니다.
- 변경 전에 관련 파일을 탐색하고, 이미 있는 유틸/스토어/타입을 재사용합니다(DRY).
- UX/성능 목표(60fps, 저지연 IPC)를 해치지 않도록 불필요한 리렌더/큰 상태를 피합니다.
- 보안: API 키/토큰은 코드/문서에 하드코딩하지 않습니다. `.env.local` 등 로컬 환경변수로만 관리합니다.

---

## 7) 문서 운영 규칙
- 문서 간 충돌이 생기면 `prd.md`/`trd.md`를 기준으로 정리합니다.
- README에는 “목표 아키텍처(=PRD/TRD)”와 “현재 구현 현황(있는 경우)”을 명확히 분리해서 적습니다.
