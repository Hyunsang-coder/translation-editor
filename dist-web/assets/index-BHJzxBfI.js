import{v as g,f as O}from"./index-1q5NHsAR.js";import"@tauri-apps/api/core";import"@tauri-apps/plugin-dialog";import"@tauri-apps/plugin-shell";import"@tauri-apps/plugin-updater";import"@tauri-apps/plugin-process";const E=(e,n)=>n.some(t=>e instanceof t);let M,F;function G(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Y(){return F||(F=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const T=new WeakMap,A=new WeakMap,j=new WeakMap;function Q(e){const n=new Promise((t,r)=>{const a=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{t(m(e.result)),a()},s=()=>{r(e.error),a()};e.addEventListener("success",o),e.addEventListener("error",s)});return j.set(n,e),n}function X(e){if(T.has(e))return;const n=new Promise((t,r)=>{const a=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{t(),a()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});T.set(e,n)}let k={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return T.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return m(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function $(e){k=e(k)}function Z(e){return Y().includes(e)?function(...n){return e.apply(B(this),n),m(this.request)}:function(...n){return m(e.apply(B(this),n))}}function q(e){return typeof e=="function"?Z(e):(e instanceof IDBTransaction&&X(e),E(e,G())?new Proxy(e,k):e)}function m(e){if(e instanceof IDBRequest)return Q(e);if(A.has(e))return A.get(e);const n=q(e);return n!==e&&(A.set(e,n),j.set(n,e)),n}const B=e=>j.get(e);function ee(e,n,{blocked:t,upgrade:r,blocking:a,terminated:o}={}){const s=indexedDB.open(e,n),d=m(s);return r&&s.addEventListener("upgradeneeded",c=>{r(m(s.result),c.oldVersion,c.newVersion,m(s.transaction),c)}),t&&s.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),d.then(c=>{o&&c.addEventListener("close",()=>o()),a&&c.addEventListener("versionchange",f=>a(f.oldVersion,f.newVersion,f))}).catch(()=>{}),d}const te=["get","getKey","getAll","getAllKeys","count"],ne=["put","add","delete","clear"],D=new Map;function K(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(D.get(n))return D.get(n);const t=n.replace(/FromIndex$/,""),r=n!==t,a=ne.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(a||te.includes(t)))return;const o=async function(s,...d){const c=this.transaction(s,a?"readwrite":"readonly");let f=c.store;return r&&(f=f.index(d.shift())),(await Promise.all([f[t](...d),a&&c.done]))[0]};return D.set(n,o),o}$(e=>({...e,get:(n,t,r)=>K(n,t)||e.get(n,t,r),has:(n,t)=>!!K(n,t)||e.has(n,t)}));const re=["continue","continuePrimaryKey","advance"],_={},C=new WeakMap,z=new WeakMap,ae={get(e,n){if(!re.includes(n))return e[n];let t=_[n];return t||(t=_[n]=function(...r){C.set(this,z.get(this)[n](...r))}),t}};async function*oe(...e){let n=this;if(n instanceof IDBCursor||(n=await n.openCursor(...e)),!n)return;n=n;const t=new Proxy(n,ae);for(z.set(t,n),j.set(t,B(n));n;)yield t,n=await(C.get(t)||n.continue()),C.delete(t)}function W(e,n){return n===Symbol.asyncIterator&&E(e,[IDBIndex,IDBObjectStore,IDBCursor])||n==="iterate"&&E(e,[IDBIndex,IDBObjectStore])}$(e=>({...e,get(n,t,r){return W(n,t)?oe:e.get(n,t,r)},has(n,t){return W(n,t)||e.has(n,t)}}));const se="oddeyes-web",ce=1;let P=null;function i(){return P||(P=ee(se,ce,{upgrade(e,n){n<1&&(e.createObjectStore("projects",{keyPath:"id"}).createIndex("by-updatedAt","metadata.updatedAt"),e.createObjectStore("chatSessions",{keyPath:"id"}).createIndex("by-projectId","projectId"),e.createObjectStore("chatSettings",{keyPath:"projectId"}),e.createObjectStore("glossary",{keyPath:["projectId","source"]}).createIndex("by-projectId","projectId"),e.createObjectStore("attachments",{keyPath:"id"}).createIndex("by-projectId","projectId"),e.createObjectStore("secrets",{keyPath:"key"}))},blocked(){console.warn("[IndexedDB] Database upgrade blocked by another tab")},blocking(){console.warn("[IndexedDB] This tab is blocking a database upgrade in another tab")}})),P}function ie(e,n){const t=Date.now(),r=g(),a=g(),o=g();return{id:r,version:"1.0.0",metadata:{title:e,description:"",domain:n,createdAt:t,updatedAt:t,settings:{strictnessLevel:.5,autoSave:!0,autoSaveInterval:3e4,theme:"system"}},segments:[{groupId:g(),sourceIds:[a],targetIds:[o],isAligned:!0,order:0}],blocks:{[a]:{id:a,type:"source",content:"<p>Hello, welcome to OddEyes.ai.</p>",hash:O("Hello, welcome to OddEyes.ai."),metadata:{createdAt:t,updatedAt:t,tags:[]}},[o]:{id:o,type:"target",content:"<p></p>",hash:O(""),metadata:{createdAt:t,updatedAt:t,tags:[]}}},history:[]}}const de={createProject:async e=>{const n=await i(),t=ie(e.title,e.domain);return await n.put("projects",t),t},saveProject:async e=>{await(await i()).put("projects",e)},loadProject:async e=>{const t=await(await i()).get("projects",e);if(!t)throw new Error(`Project not found: ${e}`);return t},deleteProject:async e=>{const n=await i();await n.delete("projects",e);const t=n.transaction(["chatSessions","chatSettings","glossary","attachments"],"readwrite"),r=await t.objectStore("chatSessions").index("by-projectId").getAllKeys(e);for(const s of r)await t.objectStore("chatSessions").delete(s);await t.objectStore("chatSettings").delete(e);const a=await t.objectStore("glossary").index("by-projectId").getAllKeys(e);for(const s of a)await t.objectStore("glossary").delete(s);const o=await t.objectStore("attachments").index("by-projectId").getAllKeys(e);for(const s of o)await t.objectStore("attachments").delete(s);await t.done},listProjectIds:async()=>await(await i()).getAllKeys("projects"),listRecentProjects:async()=>(await(await i()).getAll("projects")).sort((t,r)=>r.metadata.updatedAt-t.metadata.updatedAt).slice(0,10).map(t=>({id:t.id,title:t.metadata.title,updatedAt:t.metadata.updatedAt})),saveChatSessions:async({projectId:e,sessions:n})=>{const r=(await i()).transaction("chatSessions","readwrite"),a=await r.store.index("by-projectId").getAllKeys(e);for(const o of a)await r.store.delete(o);for(const o of n)await r.store.put({...o,projectId:e});await r.done},loadChatSessions:async e=>(await(await i()).getAllFromIndex("chatSessions","by-projectId",e)).map(({projectId:r,...a})=>a),saveChatProjectSettings:async({projectId:e,settings:n})=>{await(await i()).put("chatSettings",{...n,projectId:e})},loadChatProjectSettings:async e=>{const t=await(await i()).get("chatSettings",e);if(!t)return null;const{projectId:r,...a}=t;return a},searchGlossary:async({projectId:e,query:n,limit:t=10})=>{const a=await(await i()).getAllFromIndex("glossary","by-projectId",e),o=n.toLowerCase();return a.filter(d=>d.source.toLowerCase().includes(o)||d.target.toLowerCase().includes(o)||(d.notes?.toLowerCase().includes(o)??!1)).slice(0,t).map(({projectId:d,...c})=>c)}},N=["notion_access_token","confluence_access_token"],le={initialize:async()=>{try{return{success:!0,cachedCount:await(await i()).count("secrets")}}catch{return{success:!1,cachedCount:0}}},get:async e=>{if(e.includes("api_key")||e.includes("apiKey"))return console.warn(`[WebSecrets] API keys are not accessible in web environment: ${e}`),null;if(!N.includes(e))return null;try{return(await(await i()).get("secrets",e))?.value??null}catch{return null}},set:async(e,n)=>{if(e.includes("api_key")||e.includes("apiKey")){console.warn(`[WebSecrets] API keys cannot be stored in web environment: ${e}`);return}if(!N.includes(e)){console.warn(`[WebSecrets] Key not allowed in web environment: ${e}`);return}try{await(await i()).put("secrets",{key:e,value:n})}catch(t){console.error("[WebSecrets] Failed to set secret:",t)}},delete:async e=>{try{const t=(await i()).transaction("secrets","readwrite");for(const r of e)await t.store.delete(r);await t.done}catch(n){console.error("[WebSecrets] Failed to delete secrets:",n)}},has:async e=>{if(e.includes("api_key")||e.includes("apiKey"))return!1;try{return await(await i()).get("secrets",e)!==void 0}catch{return!1}}},ue={pickFile:async e=>new Promise(n=>{const t=document.createElement("input");if(t.type="file",t.multiple=e.multiple??!1,e.filters&&e.filters.length>0){const r=e.filters.flatMap(a=>a.extensions.map(o=>`.${o}`));t.accept=r.join(",")}t.onchange=()=>{const r=t.files?.[0];n(r?r.name:null)},t.oncancel=()=>{n(null)},t.click()}),saveFile:async e=>{if("showSaveFilePicker"in window)try{const n=e.filters?.map(r=>({description:r.name,accept:{"application/octet-stream":r.extensions.map(a=>`.${a}`)}}))??[];return(await window.showSaveFilePicker({suggestedName:e.defaultPath,types:n})).name}catch{return null}return e.defaultPath??null},confirm:async e=>window.confirm(e),alert:async e=>{window.alert(e)}};async function R(e){return new Promise(n=>{const t=document.createElement("input");if(t.type="file",t.multiple=e.multiple??!1,e.filters&&e.filters.length>0){const r=e.filters.flatMap(a=>a.extensions.map(o=>`.${o}`));t.accept=r.join(",")}t.onchange=()=>{const r=t.files?.[0];n(r?{name:r.name,type:r.type,size:r.size,file:r}:null)},t.oncancel=()=>{n(null)},t.click()})}function S(e){return e.split(".").pop()?.toLowerCase()??""}async function U(e){const n=e.type,t=S(e.name);if(n.startsWith("text/")||["md","txt"].includes(t))return await e.text()}async function fe(e){return new Promise((n,t)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=t,r.readAsDataURL(e)})}const pe={attach:async(e,n)=>{const t=await R({filters:[{name:"Attachments",extensions:["pdf","docx","pptx","md","txt","png","jpg","jpeg","webp","gif"]}]});if(!t)throw new Error("No file selected");const r=g(),a=Date.now(),o=await U(t.file),s={id:r,projectId:e,filename:t.name,fileType:S(t.name),sizeBytes:t.size,createdAt:a,blob:t.file,...o?{extractedText:o}:{}};await(await i()).put("attachments",s);const c={id:r,filename:t.name,fileType:S(t.name),fileSize:t.size,filePath:null,createdAt:a,updatedAt:a};return o&&(c.extractedText=o),c},delete:async e=>{await(await i()).delete("attachments",e)},list:async e=>(await(await i()).getAllFromIndex("attachments","by-projectId",e)).map(r=>{const a={id:r.id,filename:r.filename,fileType:r.fileType,fileSize:r.sizeBytes,filePath:null,createdAt:r.createdAt,updatedAt:r.createdAt};return r.extractedText&&(a.extractedText=r.extractedText),a}),preview:async e=>{const n=await R({filters:[{name:"Attachments",extensions:["pdf","docx","pptx","md","txt","png","jpg","jpeg","webp","gif"]}]});if(!n)throw new Error("No file selected");const t=await U(n.file);let r;["png","jpg","jpeg","webp","gif"].includes(S(n.name))&&(r=await fe(n.file));const o=Date.now(),s={id:g(),filename:n.name,fileType:S(n.name),fileSize:n.size,filePath:null,createdAt:o,updatedAt:o};return t&&(s.extractedText=t),r&&(s.thumbnailDataUrl=r),s},readImageAsDataUrl:async(e,n)=>null};function V(){return""}async function*H(e,n){let t="";for(;;){const{done:r,value:a}=await e.read();if(r)break;t+=n.decode(a,{stream:!0});const o=t.split(`
`);t=o.pop()||"";for(const s of o)if(s.startsWith("data: ")){const d=s.slice(6).trim();if(d)try{yield JSON.parse(d)}catch{}}}if(t.startsWith("data: ")){const r=t.slice(6).trim();if(r)try{yield JSON.parse(r)}catch{}}}async function we(e){const{messages:n,model:t,provider:r,temperature:a,maxTokens:o,onToken:s,onError:d,onDone:c,abortSignal:f}=e,x=`${V()}/api/ai/chat`;let y="";try{const u=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:n,model:t,provider:r,temperature:a,maxTokens:o}),...f?{signal:f}:{}});if(!u.ok){const l=await u.json().catch(()=>({error:"Unknown error"}));throw new Error(l.error||`HTTP ${u.status}`)}const h=u.body?.getReader();if(!h)throw new Error("No response body");const I=new TextDecoder;for await(const l of H(h,I)){if(f?.aborted){h.cancel();break}if(l.type==="token"&&l.content)y+=l.content,s?.(y,l.content);else{if(l.type==="error")throw new Error(l.error||"Stream error");l.type==="done"&&c?.(y)}}}catch(u){if(u instanceof Error&&u.name==="AbortError")return y;const h=u instanceof Error?u:new Error(String(u));throw d?.(h),h}return y}async function ye(e){const{sourceMarkdown:n,sourceLanguage:t,targetLanguage:r,translationRules:a,projectContext:o,translatorPersona:s,glossary:d,model:c,provider:f,onToken:v,onError:x,onDone:y,abortSignal:u}=e,I=`${V()}/api/ai/translate`;let l="";try{const p=await fetch(I,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sourceMarkdown:n,sourceLanguage:t,targetLanguage:r,translationRules:a,projectContext:o,translatorPersona:s,glossary:d,model:c,provider:f}),...u?{signal:u}:{}});if(!p.ok){const w=await p.json().catch(()=>({error:"Unknown error"}));throw new Error(w.error||`HTTP ${p.status}`)}const b=p.body?.getReader();if(!b)throw new Error("No response body");const J=new TextDecoder;for await(const w of H(b,J)){if(u?.aborted){b.cancel();break}if(w.type==="token"&&w.content)l+=w.content,v?.(l,w.content);else{if(w.type==="error")throw new Error(w.error||"Stream error");if(w.type==="done"){const L=w.fullResponse||l;return y?.(L),L}}}}catch(p){if(p instanceof Error&&p.name==="AbortError")return l;const b=p instanceof Error?p:new Error(String(p));throw x?.(b),b}return l}const he={streamChat:we,streamTranslate:ye},Ie={type:"web",storage:de,secrets:le,dialog:ue,attachments:pe,ai:he};export{Ie as webAdapter};
