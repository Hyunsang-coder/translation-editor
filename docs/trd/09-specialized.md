# 9. 특화 기능 명세 (Specialized Sub-systems)

## 9.1 Ghost Chips (태그 보호)

### What
- 특정 특수 문자나 태그(예: `<tag>`, `{var}`)가 번역 과정에서 손상되지 않도록 보호하기 위해 **Ghost Chips**를 사용합니다.
- `chatStore.ts`와 `ghostMask.ts`를 통해 모델 호출 전 마스킹하고, 응답 후 복원하는 과정을 거칩니다.

---

## 9.2 Smart Context Summarizer

### What
- 대화 토큰 임계치 모니터링과 Project Context 제안 UX는 점진 구현 중이며, Add to Rules / Add to Context 버튼을 통해 수동 반영합니다.

---

## 9.3 Confluence 단어 카운팅 (번역 분량 산정)

### Why
번역 프로젝트에서 분량 산정은 견적과 일정에 직접적 영향을 미칩니다.
Confluence 페이지의 실제 번역 대상 텍스트만 카운팅하여 정확한 분량 파악이 필요합니다.

### What
- **번역 불필요 콘텐츠 제외**: 코드 블록, 이미지, URL, 영상, 매크로
- **언어별 필터링**: 전체/영어/한국어/중국어/일본어/CJK
- **섹션별 카운팅**: 특정 Heading 아래만 선택적 카운팅
- **여러 페이지 처리**: 복수 페이지 일괄 카운팅 + 총합

### How

#### 아키텍처
MCP 응답 후처리 방식으로 자동 카운팅:
- **MCP**: `getConfluencePage`로 페이지 내용 조회
- **TypeScript**: MCP 응답 수신 시 `countWords()` 자동 실행
- **결과**: 페이지 내용 + 단어 수가 함께 LLM에 전달

```
사용자 입력 → LLM → getConfluencePage (MCP)
           → MCP 응답 + 단어 수 자동 첨부 → LLM → 응답
```

별도 도구 호출 없이 1회 왕복으로 처리되어 응답 속도 향상.

#### 카운팅 기준

**모든 언어를 공백 구분 단어 수로 통일** (번역 분량 산정 목적)

- 전처리 후 공백(`\s+`)으로 분할하여 단어 수 카운팅
- 언어별 breakdown은 각 단어에 포함된 문자로 언어 판별

#### 결과 형식

`getConfluencePage` 응답에 자동 첨부되는 단어 수 정보:

```
[페이지 내용...]

---
📊 단어 수 (자동 계산):
📊 총 단어 수: 1,234
   - 영어: 800
   - 한국어: 400
   - 중국어: 20
   - 일본어: 14
```

#### 콘텐츠 전처리 (제외 항목)

| 제외 대상 | 처리 방식 |
|----------|----------|
| 코드 블록 | 펜스 코드(```), 인라인 코드, `<pre>`, `<code>` 제거 |
| 이미지 | Markdown `![]()`, HTML `<img>` 제거 |
| URL | 순수 URL 제거, 링크 텍스트는 유지 (`[텍스트](url)` → `텍스트`) |
| 영상/임베드 | `<video>`, `<iframe>` 제거 |
| Confluence 매크로 | `<ac:structured-macro>`, `<ac:image>` 제거 |

#### 사용 시나리오

| 시나리오 | 입력 예시 | 출력 |
|---------|----------|------|
| 단일 페이지 | "페이지 전체 단어 수" | 전체 단어 수 |
| 영어만 | "영어 단어만 세어줘" | 영어 단어 수 |
| 한국어만 | "한국어만 카운팅" | 한국어 단어 수 |
| 특정 섹션 | "'설치 방법' 섹션만 세어줘" | 해당 섹션 단어 수 |
| 여러 페이지 | "이 3개 페이지 합쳐서 분량" | 각 페이지별 + 총합 |
| 조합 | "'API Reference'의 영어만" | 해당 섹션의 영어 단어 수 |

#### 포함 항목

| 포함 대상 | 설명 |
|----------|------|
| 표(테이블) | 표 안의 모든 텍스트 포함 |
| 접힌 섹션 | expand/collapse 매크로 내 텍스트 포함 |
| 일반 텍스트 | 단락, 헤딩, 리스트 등 |

### 구현 파일

| 파일 | 설명 |
|------|------|
| `src/utils/wordCounter.ts` | 핵심 단어 카운팅 로직 (순수 함수) |
| `src/utils/wordCounter.test.ts` | 단위 테스트 |
| `src/ai/mcp/McpClientManager.ts` | MCP 응답 후처리 (단어 수 자동 첨부) |

### 제한사항

1. **MCP 연결 필수**: Confluence 미연결 시 사용 불가
2. **페이지 크기 제한**: 대용량 페이지는 MCP 응답 제한에 걸릴 수 있음
3. **필터링**: 섹션별/언어별 필터링은 LLM이 응답 내용을 보고 판단
